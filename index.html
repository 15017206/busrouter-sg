<!DOCTYPE html>
<meta charset="utf-8">
<title>Singapore Bus Routes Explorer</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta name="google" value="notranslate">
<link href='http://fonts.googleapis.com/css?family=Roboto:400,300,500' rel='stylesheet' type='text/css'>
<style>
body{
	font-family: Roboto, arial, sans-serif;
}
input{
	font-family: Roboto, arial, sans-serif;
	font-weight: 300;
	font-size: 1em;
}
header{
	position: absolute;
	top: 0;
	left: 0;
	width: 320px;
	z-index: 100;
	padding: 10px;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
}
header h1{
	font-size: 1em;
	font-weight: 500;
	margin: 0 0 .5em;
	padding: 0;
	text-shadow: 0px 2px 6px #fff, 0px 2px 6px #fff, 0px 2px 6px #fff;
}
#search{
	-moz-box-sizing: border-box;
	box-sizing: border-box;
	width: 100%;
	padding: 5px;
	box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.3);
	border: 1px solid #fff;
	border-radius: 2px;
	position: relative;
	-webkit-transition: border-color .3s;
	transition: border-color .3s;
}
#search:focus{
	border-color: #4d90fe;
}
#datalist{
	z-index: 101;
	border-radius: 2px;
	position: absolute;
	display: block;
	width: 300px;
	box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.3);
	background-color: #fff;
	margin: 1px 0 0;
	padding: 0;
	list-style: none;
	overflow: hidden;
	font-size: .8em;
}
#datalist a{
	cursor: pointer;
	display: block;
	padding: 7px 10px;
	border-top: 1px solid #e6e6e6;
	color: #000;
	text-decoration: none;
}
#datalist a:hover{
	background-color: #fafafa;
}
#map{
	position: absolute;
	top: 0;
	right: 0;
	bottom: 0;
	left: 0;
}
</style>
<header>
	<h1>Singapore Bus Routes Explorer</h1>
	<input id="search" type="search" placeholder="Bus service no., stop no. or location" autocorrect="off" autocomplete="off" autofocus>
	<ul id="datalist"></ul>
</header>
<div id="map"></div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpk0BS7iLdbn5U545tiIN12k1OCgj2cc4&sensor=false"></script>
<script src="build/build.js"></script>
<script>
var ajax = require('ajax');
var path = require('microjs-path');
var parallel = require('array-parallel');
var debounce = require('debounce');

var flow = [];

flow.push(function(done){
	ajax.getJSON('data/2/bus-stops.json', function(body){
		done(null, body);
	});
});

flow.push(function(done){
	ajax.getJSON('data/2/bus-services.json', function(body){
		done(null, body);
	});
});

flow.push(function(done){
	google.maps.event.addDomListener(window, 'load', function(){
		google.maps.visualRefresh = true;

		var map = new google.maps.Map(document.getElementById('map'), {
			center: new google.maps.LatLng(1.368405, 103.84779),
			zoom: 11,
			mapTypeId: google.maps.MapTypeId.ROADMAP,
			disableDefaultUI: true,
			zoomControlOptions: {
				style: google.maps.ZoomControlStyle.SMALL,
				position: google.maps.ControlPosition.RIGHT_BOTTOM
			}
		});

		done(null, map);
	});
});

parallel(flow, function(error, results){
	var busStops = results[0];
	var busServices = results[1];
	var map = results[2];

	var $search = document.getElementById('search');
	var $datalist = document.getElementById('datalist');

	var triggerSearch = function(){
		var value = $search.value.trim();
		var html = '';

		if (value){
			var results = [];
			var exp = value.replace(/([-.*+?^${}()|[\]\/\\])/g, '\\$1').split('').reduce(function(a,b){ return a + '.*' + b; });
			var re = new RegExp(exp, 'gi');

			busServices.services.forEach(function(service){
				var no = service.no;
				var name = service.name;
				if (re.test(no + ' ' + name)){
					results.push({
						value: no,
						name: name,
						type: 'service',
						url: '#/services/' + no
					});
				}
			});

			busStops.forEach(function(stop){
				var no = stop.no;
				var name = stop.name;
				if (re.test(no + ' ' + name)){
					results.push({
						value: no,
						name: name,
						type: 'stop',
						url: '#/stops/' + no
					});
				}
			});

			results = results.slice(0, 8);

			results.forEach(function(result){
				var value = result.value;
				var name = result.name;
				html += '<li><a href="' + result.url + '" class="' + result.type + '" data-value="' + value + '">' + value + ' ' + name + '</a></li>';
			});
		}

		$datalist.innerHTML = html;
	};
	google.maps.event.addDomListener($search, 'input', debounce(triggerSearch, 100));
	google.maps.event.addDomListener($search, 'focus', triggerSearch);
	google.maps.event.addDomListener($search, 'keyup', function(){

	});

	path.map('#/').to(function(){
		var bounds = new google.maps.LatLngBounds(new google.maps.LatLng(1.25902803324958,103.640944981446), new google.maps.LatLng(1.44527693946651,103.997948007655));
		map.fitBounds(bounds);
	});

	if (!location.hash.slice(1)) path.dispatch('#/');
});
</script>