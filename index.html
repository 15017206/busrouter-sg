<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Singapore Bus Routes Explorer</title>
<meta name="apple-mobile-web-app-title" content="SG BusRoutes">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link rel="shortcut icon" href="favicon.ico">
<link rel="apple-touch-icon-precomposed" href="assets/icon_144.png">
<meta name="google" value="notranslate">
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,300,500">
<style>
html, body{
	margin: 0;
	padding: 0;
	overflow: hidden;
	width: 100%;
	height: 100%;
	font-family: 'Roboto', sans-serif;
	font-size: 14px;
	font-weight: 300;
	-webkit-text-size-adjust: none;
}
input{
	font-family: 'Roboto', sans-serif;
}
a{
	color: #1155CC;
	text-decoration: none;
}
a:hover{
	text-decoration: underline;
}
a[href="#"]{
	-webkit-touch-callout: none;
}
img{
	border: 0;
}
hr{
	margin: 8px 0 6px;
	border: 0;
	border-top: 1px solid #F0F0E7;
}
header{
	color: #fff;
	background-color: #454545;
	background-image: -webkit-linear-gradient(top, #656565, #454545);
	background-image: -moz-linear-gradient(top, #656565, #454545);
	background-image: linear-gradient(to bottom, #656565, #454545);
	position: absolute;
	top: 0;
	left: 0;
	bottom: 0;
	right: 0;
	height: 40px;
	line-height: 40px;
	padding: 0 16px;
	box-shadow: 0 0 10px rgba(0,0,0,.25);
	z-index: 3;
}
header h1{
	font-size: 16px;
	font-weight: normal;
	margin: 0;
	padding: 0;
	text-align: center;
}
header h1 a{
	color: #fff;
}
header h1 a:hover{
	text-decoration: none;
}
header h1 img{
	vertical-align: text-bottom;
	image-rendering: -moz-crisp-edges;
}
#header-about{
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
	border-radius: 15px;
	position: absolute;
	top: 5px;
	right: 5px;
	padding: 6px 18px;
	height: 30px;
	color: #fff;
	background-color: rgba(0,0,0,.3);
	display: inline-block;
	line-height: 16px;
	font-weight: normal;
	cursor: pointer;
	font-size: 13px;
}
#header-about:hover{
	text-decoration: none;
	background-color: rgba(0,0,0,.7);
}
#header-sidebar{
	display: none;
}
#places-search-form{
	position: absolute;
	top: 0;
	left: 0;
	width: 200px;
}
#places-search-form input{
	outline: 0;
	-webkit-appearance: none;
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
	border: 0;
	border-radius: 15px;
	color: #bbb;
	background-color: rgba(255,255,255,.3);
	width: 188px;
	margin: 0 5px;
	padding: 6px 12px;
	height: 30px;
	-webkit-transition: background-color .3s;
	-moz-transition: background-color .3s;
	transition: background-color .3s;
}
#places-search-form input:focus{
	background-color: #fff;
	color: #333;
}
#places-search-form input::-webkit-input-placeholder{
	color: #bbb;
}
#places-search-form input:-moz-placeholder{
	color: #bbb;
}
#about{
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	width: 100%;
	height: 100%;
	z-index: 999999;
	background-color: rgba(0,0,0,.5);
	-webkit-transition: background-color .3s;
	-moz-transition: background-color .3s;
	transition: background-color .3s;
}
#about.hidden{
	z-index: -1;
	background-color: rgba(0,0,0,0);
}
#about section{
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
	position: absolute;
	top: 20%;
	left: 50%;
	width: 480px;
	margin: 0 0 0 -240px;
	background-color: #fff;
	border-radius: 5px;
	box-shadow: 0 0 5px #000;
	padding: 16px;
	line-height: 1.5em;
	-webkit-transform: scale(1, 1);
	-moz-transform: scale(1, 1);
	transform: scale(1, 1);
	-webkit-transition: -webkit-transform .3s;
	-moz-transition: -moz-transform .3s;
	transition: transform .3s;
}
#about.hidden section{
	-webkit-transform: scale(0, 0);
	-moz-transform: scale(0, 0);
	transform: scale(0, 0);
}
#about section .close{
	display: inline-block;
	position: absolute;
	top: -12px;
	right: -12px;
	width: 24px;
	height: 24px;
	line-height: 24px;
	text-align: center;
	font-weight: 500;
	color: #fff;
	background-color: #000;
	border-radius: 50%;
	cursor: pointer;
	opacity: .75;
}
#about section .close:hover{
	text-decoration: none;
	opacity: 1;
}
#map{
	position: absolute;
	top: 40px;
	left: 0;
	bottom: 0;
	right: 300px;
	background-color: #E5E3DF;
}
aside{
	position: absolute;
	top: 40px;
	bottom: 0;
	right: 0;
	width: 300px;
	z-index: 1;
	box-shadow: 0 0 10px rgba(0,0,0,.25);
	overflow: hidden;
}
aside h1{
	color: #fff;
	background-color: #7ac000;
	margin: 0;
	padding: 0 16px;
	height: 32px;
	line-height: 32px;
	font-size: 16px;
	font-weight: normal;
}
aside #bus-stops-section h1,
aside #bus-stop-routes-section h1{
	background-color: #f01b48;
	font-weight: normal;
}
aside h1 b{
	font-weight: 500;
}
aside h1 a{
	color: #fff;
}
aside h1 a.close{
	font-weight: 500;
	color: #fff;
	display: inline-block;
	position: absolute;
	top: 0;
	right: 0;
	width: 32px;
	height: 32px;
	line-height: 32px;
	text-align: center;
}
aside h1 a.close:hover{
	text-decoration: none;
	background-color: rgba(0,0,0,.15);
}
aside section{
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	width: 100%;
	background-color: #f7f7f7;
}
aside section>div{
	position: absolute;
	top: 32px;
	left: 0;
	bottom: 0;
	right: 0;
	width: 100%;
	overflow-y: auto;
	overflow-x: hidden;
	-webkit-overflow-scrolling: touch;
}
aside section p{
	margin: 0;
	padding: 16px;
	color: #666;
	text-align: center;
}
aside section div h2{
	color: #999;
	background-color: #f7f7f7;
	margin: 0;
	padding: 0 16px;
	height: 24px;
	line-height: 24px;
	font-size: 12px;
	font-weight: normal;
	border-bottom: 1px solid #ededed;
}
aside section div ul{
	margin: 0;
	padding: 0;
	list-style: none;
}
aside section div ul li{
	display: inline;
}
aside section div ul li a{
	color: #333;
	background-color: #fff;
	display: block;
	padding: 0 16px;
	height: 32px;
	line-height: 32px;
	border-bottom: 1px solid #ededed;
	overflow: hidden;
	cursor: pointer;
	-webkit-transition: background-color .3s;
	-moz-transition: background-color .3s;
	transition: background-color .3s;
}
aside section div ul li a:hover{
	text-decoration: none;
	color: #000;
	background-color: #fafafa;
}
#sidebar section#bus-services-section div ul li a:active,
#sidebar section#bus-services-section div ul li a.selected{
	color: #fff;
	background-color: #95cf29;
}
#sidebar section#bus-routes-section div ul li a:active .tag,
#sidebar section#bus-routes-section div ul li a.selected .tag,
#sidebar section#bus-stops-section div ul li a:active .tag,
#sidebar section#bus-stops-section div ul li a.selected .tag{
	color: #fff;
	background-color: #f78da3;
}
#bus-routes-section a.details{
	font-size: 12px;
	display: block;
	margin: 8px;
	padding: 8px;
	text-align: center;
	font-weight: normal;
	border-radius: 8px;
	border: 1px solid #EDEDED;
	background-color: rgba(255,255,255,.5);
}
#bus-routes-section a.details:hover{
	background-color: #fff;
}
#bus-routes-section a.details:active{
	background-color: #ededed;
}
aside section div ul li a.stop-a{
	padding-left: 48px;
	background: #fff url(assets/red-circle-a.png) no-repeat 12px 2px;
	background-size: 26px 27px;
}
aside section div ul li a.stop-b{
	padding-left: 48px;
	background: #fff url(assets/red-circle-b.png) no-repeat 12px 2px;
	background-size: 26px 27px;
}
aside section div ul li a.stop-dot{
	padding-left: 48px;
	background: #fff url(assets/red-circle-dot.png) no-repeat 12px 2px;
	background-size: 26px 27px;
}
aside section div ul li a.stop{
	padding-left: 48px;
	background: #fff url(assets/red-circle.png) no-repeat 16px center;
	background-size: 18px 19px;
	image-rendering: -moz-crisp-edges;
}
aside section div ul li a .tag{
	vertical-align: middle;
	display: inline-block;
	font-weight: normal;
	font-size: 12px;
	color: #999;
	background-color: #ededed;
	padding: 3px 5px;
	margin: 0 5px 0 0;
	line-height: 1em;
	border-radius: 3px;
}
aside section #bus-stop-routes ul li a .tag{
	border-radius: 0;
}
aside section #bus-stop-routes ul li a:focus .tag,
aside section #bus-stop-routes ul li a:hover .tag{
	color: #fff;
	background-color: #95cf29;
}
aside section .tab{
	width: 50%;
	color: #999;
	display: inline-block;
	text-align: center;
	padding: 7px 0;
	font-weight: normal;
	border-bottom: 1px solid #ededed;
}
aside section .tab:hover{
	color: #000;
	text-decoration: none;
}
aside section .tab.selected{
	border-color: #fff;
	color: #000;
	background-color: #fff;
}
aside section{
	-webkit-transition-property: -webkit-transform, opacity;
	-webkit-transition-duration: .3s;
	-moz-transition-property: -moz-transform, opacity;
	-moz-transition-duration: .3s;
	transition-property: transform, opacity;
	transition-duration: .3s;
}
aside section.hidden{
	opacity: 0;
	-webkit-transform: translate3d(100%, 0, 0);
	-moz-transform: translateX(100%);
	transform: translateX(100%);
}
.arrow{
	display: inline-block;
	vertical-align: middle;
	font-size: 10px;
	opacity: .6;
}
#bus-services-section.loading #bus-services ul li a.selected{
	background-image: url(assets/loader.gif);
	background-position: 97% center ;
	background-repeat: no-repeat;
}
#bus-stop-routes-section.loading h1 a.close{
	display: none;
}
#bus-stop-routes-section.loading #bus-stop-routes{
	background-image: url(assets/loader-large.gif);
	background-repeat: no-repeat;
	background-position: center;
}
.infowindow{
	font-size: 13px;
}
.infowindow h1{
	font-size: 14px;
	font-weight: normal;
	margin: 0 0 2px;
	padding: 0;
}
.infowindow .tag{
	vertical-align: middle;
	display: inline-block;
	font-weight: normal;
	font-size: 12px;
	color: #fff;
	background-color: #f78da3;
	padding: 3px 5px;
	margin: 0 5px 0 0;
	line-height: 1em;
	border-radius: 3px;
}
.infowindow a.infoservice,
.infowindow span.infoservice{
	font-weight: normal;
	font-size: 12px;
	color: #fff;
	background-color: #95cf29;
	padding: 2px 6px;
	margin: 4px 0 0;
	display: inline-block;
}
.infowindow a.infoservice:hover{
	background-color: #7ac000;
	text-decoration: none;
}
.infowindow span.infoservice{
	color: #999;
	background-color: #ededed;
}
.infowindow .infostop,
.infowindow .show-routes{
	white-space: nowrap;
}

#geolocation-control{
	border: 1px solid rgba(0,0,0,.4);
	background: rgba(255,255,255,.8) url(assets/geolocation-arrow.png) no-repeat 40% 60%;
	background-size: 15px 15px;
	image-rendering: -moz-crisp-edges;
	width: 32px;
	height: 32px;
	border-radius: 5px;
	margin: 5px;
	cursor: pointer;
	box-shadow: 0 1px 2px rgba(0,0,0,.1);
}

#geolocation-control.active{
	background-image: url(assets/geolocation-arrow-active.png);
}

@media screen and (max-width: 640px){
	body{
		position: relative;
	}

	#places-search-form{
		display: none;
	}

	header h1{
		text-align: left;
		font-size: 14px;
	}

	#map{
		right: 0;
	}

	#header-about{
		display: none;
	}

	#about section{
		top: 80px;
		left: 5%;
		width: 90%;
		margin: 0;
	}

	#header-sidebar{
		-webkit-box-sizing: border-box;
		-moz-box-sizing: border-box;
		box-sizing: border-box;
		position: absolute;
		top: 0;
		right: 0;
		height: 40px;
		width: 50px;
		line-height: 40px;
		color: #fff;
		background-color: transparent;
		display: inline-block;
		font-weight: normal;
		cursor: pointer;
		font-size: 16px;
		text-align: center;
		text-decoration: none;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}
	#header-sidebar.active{
		text-decoration: none;
		background-color: rgba(0,0,0,.4);
	}

	#sidebar{
		-webkit-transition-property: -webkit-transform, opacity;
		-webkit-transition-duration: .3s;
		-moz-transition-property: -moz-transform, opacity;
		-moz-transition-duration: .3s;
		transition-property: transform, opacity;
		transition-duration: .3s;
		opacity: 1;
	}

	#sidebar.hidden{
		opacity: 0;
		pointer-events: none;
	}
}
</style>
<script>
if (location.hostname == 'cheeaun.github.io'){
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-23235796-4']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();

	(function(e,t,r){if(!r.version&&!r.__ai){e.debuggify=r;var a,n,s,o="debuggify",g=Array.prototype.slice,i={};r._e=[];s=e.onerror;e.onerror=function(){r._e&&r._e.push(arguments);return s?s.apply(this,arguments):void 0};r.init=function(e,s,c){function u(e,t,r,a){var n=r.split(".");if(2==n.length){e=e[n[0]];r=n[1]}e[r]=function(){var e=a?a+"#"+r:r;t.push([e].concat(g.call(arguments,0)))}}function p(e,t,r,a){var n,s=r.split(" ");for(n=0;s.length>n;n++)u(e,t,s[n],a)}a=t.createElement("script");a.type="text/javascript";a.async=!0;a.src="https://cdn.debuggify.net/js/"+e+"/debuggify.logger.http.js";n=t.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);var d=r;c!==void 0?d=r[c]=[]:c=o;d.Logger=d.Logger||[];var l=d.Logger;p(d,d,"Logger.get setEnv addTransport setDefaults onload alias metadata",null);var f=function(e){var t=this,r=i[n],a={},n=t&&t.namespace?t.namespace+"__"+e:e;if(r!==void 0)return i[n];p(a,l,"setLevel setFlag get message setNamespace addTransport sendToCollector report track untrack setUID isTracked genericMessage attach log warn error info debug",n);a.name=e;a.get=f;a.namespace=n;a.parent=t;i[n]=a;l.push(["get"].concat(g.call(arguments,0)));return a};l.get=f};r.__ai="0.2.0"}})(window,document,window.debuggify||[]);debuggify.init("a8598b18df7d47de27b4bbf02fdca20f");
}
</script>
</head>
<body ontouchstart><!-- make a:active work on iOS Mobile Safari -->
<header>
	<h1><a href="#/"><img src="assets/logo.png" width="16" height="20" alt=""> &nbsp;Singapore Bus Routes Explorer</a></h1>
	<form id="places-search-form">
		<input type="search" placeholder="Search for a place">
	</form>
	<a id="header-about">About</a>
	<a id="header-sidebar" class="active">&#9776;</a>
</header>
<div id="about" class="hidden">
	<section>
		<a class="close">&times;</a>
		<b>Singapore Bus Routes Explorer</b> is <a href="https://github.com/cheeaun/busrouter-sg" target="_blank">yet another project</a> by <a href="http://twitter.com/cheeaun" target="_blank">@cheeaun</a>. This works best on <strong>modern web browsers</strong> and the data is <em>extracted</em> from the <a href="http://www.publictransport.sg/">Land Transport Authority</a>. Feel free to <a href="http://twitter.com/cheeaun" target="_blank">send feedback</a>, <a href="https://github.com/cheeaun/busrouter-sg/issues" target="_blank">report any issues</a> and share this with your friends.
	</section>
</div>
<aside id="sidebar">
	<section id="bus-services-section">
		<h1>Bus Services</h1>
		<div id="bus-services"></div>
	</section>
	<section id="bus-routes-section" class="extra hidden">
		<h1>Routes for Bus Service <b></b> <a href="#/" class="close">&times;</a></h1>
		<div id="bus-routes"></div>
	</section>
	<section id="bus-stops-section" class="extra hidden">
		<h1>Bus Stops <a href="#" class="close">&times;</a></h1>
		<div id="bus-stops"></div>
	</section>
	<section id="bus-stop-routes-section" class="extra hidden">
		<h1>Routes for Bus Stop <b></b> <a href="#/" class="close">&times;</a></h1>
		<div id="bus-stop-routes"></div>
	</section>
</aside>
<div id="map"></div>
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDpk0BS7iLdbn5U545tiIN12k1OCgj2cc4&libraries=places&sensor=false"></script>
<script src="js/scripts.js"></script>
<script>
(function(){
	var dataVersion = '2'; // Versioning for all the bus data
	var currentDataVersion = lscache.get('busDataVersion');
	if (dataVersion != currentDataVersion && localStorage && localStorage.length && localStorage.removeItem){
		// Remove amplify's localStorage
		for (var i = localStorage.length-1; i >= 0 ; --i) {
			var key = localStorage.key(i);
			if (key.indexOf('__amplify__bus') === 0) {
				localStorage.removeItem(key);
			}
		}
		lscache.flush();
		lscache.set('busDataVersion', dataVersion);
	}

	if (/mobi/i.test(navigator.userAgent)){
		var scrollTop = function(){
			var body = document.body;
			setTimeout(function(){
				body.style.height = screen.height + 'px';
				window.scrollTo(0, 0);
				body.style.height = window.innerHeight + 'px';
			}, 300);
		};
		scrollTop();
		window.onresize = scrollTop;
	}

	var markerImage = {
		location: {
			url: 'assets/blue-circle.png',
			scaledSize: new google.maps.Size(36/2, 38/2),
			anchor: new google.maps.Point(36/4, 38/4)
		},
		circle: {
			url: 'assets/red-circle.png',
			scaledSize: new google.maps.Size(36/2, 38/2),
			anchor: new google.maps.Point(36/4, 38/4)
		},
		dot: {
			url: 'assets/red-pin-dot.png',
			scaledSize: new google.maps.Size(52/2, 76/2)
		},
		a: {
			url: 'assets/red-pin-a.png',
			scaledSize: new google.maps.Size(52/2, 76/2)
		},
		b: {
			url: 'assets/red-pin-b.png',
			scaledSize: new google.maps.Size(52/2, 76/2)
		}
	};

	var dataEndPoints = {
		busStops: 'data/2/bus-stops.json',
		busServices: 'data/2/bus-services.json',
		busService: 'data/2/bus-services/{{no}}.json',
		busStopsServices: 'data/2/bus-stops-services.json'
	};

	var getData = function(key, params, done){
		if (arguments.length == 2){
			done = params;
			params = {};
		}
		var data = lscache.get(key);
		if (data){
			done(null, data);
		} else {
			var endPoint = dataEndPoints[key.split('-')[0]];
			for (p in params) endPoint = endPoint.replace('{{' + p + '}}', params[p]);
			var xhr = new XMLHttpRequest();
			xhr.onload = function(){
				try{
					var data = JSON.parse(this.responseText);
					done(null, data);
					lscache.set(key, data, 24*60);
				} catch (e){
					done(e);
				}
			};
			xhr.onerror = xhr.onabort = done;
			xhr.open('get', endPoint, true);
			xhr.send();
		}
	};

	var isSmallScreen = window.innerWidth <= 640;

	var q = queue();

	[
		function(callback){
			getData('busStops', callback);
		},
		function(callback){
			getData('busServices', callback);
		},
		function(callback){
			getData('busStopsServices', callback);
		},
		function(callback){
			window.onload = function(){
				google.maps.visualRefresh = true;
				var map = new google.maps.Map(document.getElementById('map'), {
					center: new google.maps.LatLng(1.3520830, 103.8198360),
					zoom: 11,
					mapTypeId: google.maps.MapTypeId.ROADMAP,
					disableDefaultUI: true,
					overviewMapControl: true,
					overviewMapControlOptions: {
						opened: true
					},
					zoomControl: true,
					zoomControlOptions: {
						style: google.maps.ZoomControlStyle.SMALL,
						position: google.maps.ControlPosition.RIGHT_BOTTOM
					}
				});

				if (isSmallScreen){
					map.setOptions({
						overviewMapControl: false,
						zoomControl: false
					});
				}

				var bounds = new google.maps.LatLngBounds(new google.maps.LatLng(1.1663980,103.60557550), new google.maps.LatLng(1.47088090,104.08568050));
				map.fitBounds(bounds);

				if (navigator.geolocation){
					var geolocationControl = document.createElement('a');
					geolocationControl.id = 'geolocation-control';
					geolocationControl.href = '#';
					map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(geolocationControl);

					var locationMarker = new google.maps.Marker({
						map: map,
						clickable: false,
						title: 'Current location',
						icon: markerImage.location,
						cursor: 'default',
						visible: false,
						zIndex: 9001
					});
					var locationCircle = new google.maps.Circle({
						map: map,
						clickable: false,
						fillColor: '#00b4d2',
						fillOpacity: 0.1,
						strokeWeight: 0,
						visible: false,
						zIndex: 9000
					});

					var watching = false, watch;
					var unwatch = function(){
						navigator.geolocation.clearWatch(watch);
						watching = false;
						locationCircle.setVisible(false);
						locationMarker.setVisible(false);
						$('#geolocation-control').removeClass('active');
					};

					$('#map').on('click', '#geolocation-control', function(e){
						e.preventDefault();
						if (watching){
							var pos = locationMarker.getPosition();
							if (map.getBounds().contains(pos)){
								unwatch();
							} else {
								map.panTo(pos);
							}
						} else {
							var panToLocation = false;
							watch = navigator.geolocation.watchPosition(function(position){
								watching = true;
								var coords = position.coords;
								var pos = new google.maps.LatLng(coords.latitude, coords.longitude);
								locationCircle.setCenter(pos);
								locationCircle.setRadius(coords.accuracy);
								locationCircle.setVisible(true);
								locationMarker.setPosition(pos);
								locationMarker.setVisible(true);
								if (!panToLocation && bounds.contains(pos)){
									map.panTo(pos);
									panToLocation = true;
								}
								$('#geolocation-control').addClass('active');
							}, function(e){
								unwatch();
								alert('Unable to get your location. Please try again.');
							}, {
								enableHighAccuracy: true,
								timeout: 60*1000, // 1 min timeout
								maximumAge: 5*1000 // 5-second cache
							})
						}
					});
				}

				if (!isSmallScreen){
					// This panning thing is buggy on iOS Mobile Safari
					var maxX = bounds.getNorthEast().lng();
					var maxY = bounds.getNorthEast().lat();
					var minX = bounds.getSouthWest().lng();
					var minY = bounds.getSouthWest().lat();
					var panBackToBounds = function(){
						var c = map.getCenter();
						var x = c.lng();
						var y = c.lat();

						if (x < minX) x = minX;
						if (x > maxX) x = maxX;
						if (y < minY) y = minY;
						if (y > maxY) y = maxY;

						map.panTo(new google.maps.LatLng(y, x));
					};
					google.maps.event.addListener(map, 'dragend', panBackToBounds);
					google.maps.event.addListener(map, 'zoom_changed', panBackToBounds);

					var $form = $('#places-search-form');
					$form.on('submit', function(e){
						e.preventDefault();
					});

					var autocomplete = new google.maps.places.Autocomplete($form.find('input')[0], {
						bounds: bounds,
						componentRestrictions: {country: 'sg'}
					});
					google.maps.event.addListener(autocomplete, 'place_changed', function(){
						var place = autocomplete.getPlace();
						if (!place.geometry) return;
						if (place.geometry.viewport) {
							map.fitBounds(place.geometry.viewport);
						} else {
							map.setCenter(place.geometry.location);
							map.setZoom(17);
						}
					});
				}

				callback(null, map);
			};
		}
	].forEach(function(task){
		q.defer(task);
	});

	q.awaitAll(function(error, results){
		if (error || !results || results.length != 4){
			alert('Oops, an error occured.');
			return;
		}

		var busStops = results[0];
		var busServices = results[1];
		var busStopsServices = results[2];
		var map = results[3];

		var busStopsMap = {};
		busStops.forEach(function(stop){
			busStopsMap[stop.no] = stop;
		});

		var busServicesByType = {};
		var busServicesMap = {};

		busServices.services.forEach(function(service){
			var type = service.type;
			if (busServicesByType[type]){
				busServicesByType[type].push(service);
			} else {
				busServicesByType[type] = [service];
			}
			busServicesMap[service.no] = service;
		});

		var $busServices = $('#bus-services');
		var html = '';
		for (type in busServicesByType){
			var services = busServicesByType[type];
			html += '<h2>' + busServices.types[type] + '</h2><ul>';
			for (var i=0, l=services.length; i<l; i++){
				var service = services[i];
				var no = service.no;
				html += '<li><a href="#/services/' + no + '" id="service-' + no + '">' + no + '</a></li>';
			}
			html += '</ul>';
		}
		$busServices.html(html);

		var markers = [];
		var polylines = {};
		var infowindow = new google.maps.InfoWindow({
			maxWidth: 260
		});
		var polyline = new google.maps.Polyline({
			clickable: false,
			strokeColor: '#f01b48',
			strokeWeight: 5,
			strokeOpacity: .5
		});

		var clearMap = function(){
			markers.forEach(function(marker){
				marker.setMap(null);
				google.maps.event.clearInstanceListeners(marker);
			});
			markers = [];
			for (var stop in stopMarkers){
				var marker = stopMarkers[stop];
				marker.setMap(null);
				google.maps.event.clearInstanceListeners(marker);
			}
			stopMarkers = {};
			for (var service in polylines){
				var line = polylines[service];
				line.setMap(null);
				google.maps.event.clearInstanceListeners(line);
			}
			polylines = {};
			polyline.setMap(null);
			infowindow.close();
		};

		google.maps.event.addListener(map, 'markerClick', function(data){
			var marker = data.marker;
			var stop = data.stop;
			var currentService = data.currentService;
			var hideShowRoutesLink = data.hideShowRoutesLink;
			var info = busStopsMap[stop];
			var name = info.name;
			var services = busStopsServices[stop];
			var html = '<div class="infowindow"><h1>' + name + '</h1>'
				+ '<div class="infostop">Bus stop number: <span class="tag">' + stop + '</span></div>';

			services.forEach(function(service){
				if (service == currentService){
					html += '<span class="infoservice">' + service + '</span> ';
				} else {
					html += '<a href="#/services/' + service + '" class="infoservice">' + service + '</a> ';
				}
			});

			if (services.length > 1 && !hideShowRoutesLink){
				html += '<hr><a href="#/stops/' + stop + '" class="show-routes">Show all routes passing here</a>';
			}
			html += '</div>';

			infowindow.setContent(html);
			infowindow.open(map, marker);
		});

		var stopMarkers = {};
		google.maps.event.addListener(map, 'idle', function(){
			if (!/stops$/i.test(location.hash) && location.hash != '#/') return;
			var $busStops = $('#bus-stops');
			var zoom = map.getZoom();
			if (zoom >= 15){
				$('#bus-stops-section').removeClass('hidden');

				var bounds = map.getBounds();

				for (var no in stopMarkers){
					var m = stopMarkers[no];
					if (!bounds.contains(m.getPosition())){
						m.setMap(null);
						delete stopMarkers[no];
					}
				}

				var busStopsOnMap = [];
				busStops.forEach(function(stop){
					var no = stop.no;
					if (!stopMarkers[no]){
						var position = new google.maps.LatLng(stop.lat, stop.lng);
						if (!bounds.contains(position)) return;

						var marker = new google.maps.Marker({
							position: position,
							map: map,
							title: stop.name,
							icon: markerImage.circle
						});

						google.maps.event.addListener(marker, 'click', function(){
							google.maps.event.trigger(map, 'markerClick', {
								marker: marker,
								stop: no
							});
						});

						stopMarkers[no] = marker;
					}

					busStopsOnMap.push({
						no: no,
						stop: stop
					});
				});

				if (busStopsOnMap.length){
					var html = '<ul>';
					busStopsOnMap.sort(function(a, b){
						var aName = a.stop.name;
						var bName = b.stop.name;
						if (aName < bName) return -1;
						if (aName > bName) return 1;
						return 0;
					});
					busStopsOnMap.forEach(function(b){
						var no = b.no;
						var name = b.stop.name;
						html += '<li><a class="stop" id="stop-' + no + '"><span class="tag">' + no + '</span> ' + name + '</a></li>';
					});
					html += '</ul>';
					$busStops.html(html);
				} else {
					$busStops.html('<p>Try zoom in or pan around to see bus stops on the map.</p>');
				}
			} else {
				for (var no in stopMarkers) stopMarkers[no].setMap(null);
				stopMarkers = [];
				$busStops.html('<p>Try zoom in or pan around to see bus stops on the map.</p>');
			}
		});

		$('#bus-stops').on('click', 'li a', function(e){
			e.preventDefault();
			var stop = $(this).find('.tag').text();
			var marker = stopMarkers[stop];
			var latlng = marker.getPosition();
			map.panTo(latlng);
			google.maps.event.trigger(marker, 'click');
		});
		$('#bus-stops-section').on('click', 'a.close', function(e){
			e.preventDefault();
			$('#bus-stops-section').addClass('hidden');
		});

		var $busRoutes = $('#bus-routes');
		var currentNo;

		var docTitle = document.title;
		ruto
			.config({
				notfound: function(){
					ruto.go('/');
				}
			})
			.add('/', function(){
				document.title = docTitle;
				$('section.extra').addClass('hidden');
				clearMap();
				setTimeout(function(){
					$busServices.find('a.selected').removeClass('selected');
				}, 400);
			})
			.add(/^\/services\/(\w+)\/?(\d)?$/i, function(path, no, route){
				document.title = 'Bus service ' + no + ' - ' + docTitle;
				if (!route) route = 1;

				// reset
				$busServices.find('a.selected').removeClass('selected');
				$('#service-' + no).addClass('selected');
				clearMap();

				var run = function(data){
					$('#bus-services-section').removeClass('loading');
					if (!data) return;

					var one = data[route];
					var routes = one.route;
					var stops = one.stops;
					var latlngs = [];
					var locations = [];

					for (var i=0, l=routes.length; i<l; i++){
						var coord = routes[i];
						var latlng = coord.split(',');
						var position = new google.maps.LatLng(parseFloat(latlng[0], 10), parseFloat(latlng[1], 10));
						latlngs.push(position);
					}
					polyline.setPath(latlngs);
					polyline.setMap(map);

					var html = '';
					var provider = busServicesMap[no].operator;
					if (provider){
						// Only SBS or SMRT, for now.
						var url = provider == 'sbs' ? 'http://www.sbstransit.com.sg/journeyplan/servicedetails.aspx?serviceno=' : 'http://www.smrtbuses.com.sg/ebusguide/busfrequency.asp?BusNo=';
						html += '<a href="' + url + no + '" target="_blank" class="details">See Bus Details and Schedules</a>';
					}
					if (data[2] && data[2].route && data[2].route.length){
						html += '<a href="#/services/' + no + '" class="tab ' + (route == 1 ? 'selected' : '') + '">Route 1</a>'
							+ '<a href="#/services/' + no + '/2" class="tab ' + (route == 2 ? 'selected' : '') + '">Route 2</a>';
					}
					html += '<ul>';

					var firstSameLast = false;
					var l = stops.length;
					var bounds = new google.maps.LatLngBounds();

					stops.forEach(function(stop, i){
						var info = busStopsMap[stop];
						var name = info.name;
						var services = busStopsServices[stop];
						var icon = markerImage.circle;
						var last = l-1;
						var className = 'stop';

						if (i == 0){
							var lastStop = stops[last];
							var lastInfo = busStopsMap[lastStop];
							if (name == lastInfo.name){
								firstSameLast = true;
								icon = markerImage.dot;
								className = 'stop-dot';
							} else {
								icon = markerImage.a;
								className = 'stop-a';
							}
						} else if (i == last){
							if (firstSameLast){
								icon = markerImage.dot;
								className = 'stop-dot';
							} else {
								icon = markerImage.b;
								className = 'stop-b';
							}
						}
						if (i == last && firstSameLast){
							// Push the first marker as the last one. MINDBLOWN!
							markers.push(markers[0]);
						} else {
							var position = new google.maps.LatLng(info.lat, info.lng);
							var marker = new google.maps.Marker({
								position: position,
								map: map,
								icon: icon,
								title: name,
								animation: (i == 0 || i == last) ? google.maps.Animation.DROP : null,
								zIndex: (i == 0 || i == last) ? 5 : 1
							});
							google.maps.event.addListener(marker, 'click', function(){
								google.maps.event.trigger(map, 'markerClick', {
									marker: marker,
									stop: stop,
									currentService: no
								});
								$busRoutes.find('li a.selected').removeClass('selected');
								$('.stop-' + stop + '[data-index="' + i + '"]').addClass('selected').focus();
							});
							markers.push(marker);

							bounds.extend(position);
						}

						html += '<li><a tabindex="0" href="#" class="' + className + ' stop-' + stop + '" data-index="' + i + '"><span class="tag">' + stop + '</span> ' + name + '</a></li>';
					});

					$busRoutes.html(html + '</ul>');
					$busRoutes[0].scrollTop = 0;
					$('#bus-routes-section h1 b').text(no);
					$('section.extra').addClass('hidden');
					$('#bus-routes-section').removeClass('hidden');

					if (no != currentNo || !bounds.contains(map.getCenter())){
						currentNo = no;
						map.fitBounds(bounds);
					}

					lscache.set('busService-' + no, data, 24*60);
				};

				getData('busService-' + no, {no: no}, function(e, serviceData){
					run(serviceData);
				});
			})
			.add(/^\/stops\/(\w+)$/i, function(path, stop){
				document.title = 'Bus stop ' + stop + ' - ' + docTitle;
				clearMap();

				$('#bus-stop-routes-section').removeClass('hidden').addClass('loading').find('h1 b').text(stop);

				var stopData = busStopsMap[stop];
				var position = new google.maps.LatLng(stopData.lat, stopData.lng);
				var marker = new google.maps.Marker({
					position: position,
					map: map,
					icon: markerImage.dot,
					title: stopData.name,
					animation: google.maps.Animation.DROP
				});

				google.maps.event.addListener(marker, 'click', function(){
					google.maps.event.trigger(map, 'markerClick', {
						marker: marker,
						stop: stop,
						hideShowRoutesLink: true
					});
				});
				markers.push(marker);

				var services = busStopsServices[stop];
				var servicesBounds = new google.maps.LatLngBounds();
				var html = '';

				var run = function(data, service){
					var d = data['1'];
					var stops = d.stops;

					// The stop could be in the second route instead and
					// could also be the last stop of the route, so choose the second route
					if (stops.indexOf(stop) == -1 || stops[stops.length-1] == stop){
						d = data['2'];
						stops = d.stops;
						if (stops.indexOf(stop) == -1){
							// Failsafe, if second route somehow doesn't have the stop for some reason
							d = data['1'];
							stops = d.stops;
						}
					}

					stops.forEach(function(stopNo){
						var stop = busStopsMap[stopNo];
						servicesBounds.extend(new google.maps.LatLng(stop.lat, stop.lng));
					});

					var routes = d.route;
					var latlngs = [];
					var locations = [];

					for (var i=0, l=routes.length; i<l; i++){
						var coord = routes[i];
						var latlng = coord.split(',');
						var position = new google.maps.LatLng(parseFloat(latlng[0], 10), parseFloat(latlng[1], 10));
						latlngs.push(position);
					}
					var line = new google.maps.Polyline({
						strokeColor: '#f01b48',
						strokeWeight: 5,
						strokeOpacity: .4,
						path: latlngs,
						map: map
					});
					google.maps.event.addListener(line, 'mouseover', function(){
						$('#stop-service-' + service).trigger('mouseover').focus();
					});
					google.maps.event.addListener(line, 'mouseout', function(){
						$('#stop-service-' + service).trigger('mouseout').blur();
					});
					google.maps.event.addListener(line, 'click', function(){
						location.href = $('#stop-service-' + service).attr('href');
					});
					polylines[service] = line;

					html += '<li><a href="#/services/' + service + '" id="stop-service-' + service + '"><span class="tag">' + service + '</span> '+ busServicesMap[service].name
						+ '</a></li>';
				};

				var q = queue();

				services.forEach(function(no){
					q.defer(function(callback){
						getData('busService-' + no, {no: no}, function(e, serviceData){
							run(serviceData, no);
							callback();
						});
					});
				});

				q.awaitAll(function(){
					map.fitBounds(servicesBounds);

					$('#bus-stop-routes-section').removeClass('loading');
					$('#bus-stop-routes').html('<ul>' + html + '</ul>');
				});
			})
			.init();

		$('#bus-routes').on('click', 'li a', function(e){
			e.preventDefault();
			var stopIndex = $(this).data('index');
			var marker = markers[stopIndex];
			if (!marker) return;
			var latlng = marker.getPosition();

			if (map.getZoom() < 15) map.setZoom(15);
			map.panTo(latlng);
			google.maps.event.trigger(marker, 'click');
			if (isSmallScreen) $('#header-sidebar').trigger('click');
		});

		$('#bus-stop-routes').on('mouseover', 'li a', function(){
			var serv = $(this).find('.tag').text();
			for (var service in polylines){
				var line = polylines[service];
				if (service == serv){
					line.setOptions({
						strokeOpacity: .8
					});
				} else {
					line.setOptions({
						strokeOpacity: .1
					});
				}
			}
		}).on('mouseout', 'li a', function(){
			for (var service in polylines){
				polylines[service].setOptions({
					strokeOpacity: .4
				});
			}
		});

		$(document).on('keyup', function(e){
			if (!(/services\/.+/i).test(location.hash)) return;
			if (e.target.tagName && e.target.tagName.toLowerCase() == 'input') return;
			var key = e.keyCode;
			switch (key){
				case 39:
				case 40:
					var $selected = $busRoutes.find('li a.selected');
					if (!$selected.length) return;
					$selected.removeClass('selected');
					var $nextLi = $selected.parent().next();
					if (!$nextLi.length) return;
					$nextLi.find('a').trigger('click');
					break;
				case 37:
				case 38:
					var $selected = $busRoutes.find('li a.selected');
					if (!$selected.length) return;
					$selected.removeClass('selected');
					var $prevLi = $selected.parent().prev();
					if (!$prevLi.length) return;
					$prevLi.find('a').trigger('click');
					break;
			}
		});
	});

	$('#header-about').on('click', function(){
		$('#about').removeClass('hidden');
	});
	$('#about .close').on('click', function(){
		$('#about').addClass('hidden');
	});

	if (isSmallScreen){
		$('header h1 a').on('click', function(e){
			e.preventDefault();
			$('#about').toggleClass('hidden');
		});
	}

	$('#bus-routes-section').on('click', 'a.details', function(e){
		e.preventDefault();

		var width = 640;
		var height = 480;
		var top = ((screen.availHeight || screen.height)-height)/2;
		var left = (screen.width-width)/2;

		window.open(this.href, 'bus-details', 'width=' + width + ',height=' + height + ',menubar=0,resizable=1,scrollbars=1,toolbar=0,top=' + top + ',left=' + left);
	});

	$('#header-sidebar').on('click', function(){
		$('#sidebar').toggleClass('hidden');
		$('#header-sidebar').toggleClass('active')
	});
})();
</script>
</body>
</html>